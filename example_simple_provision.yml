# example_simple_provision.yml
# ----------------------------------------------------------------------------
# This example demonstrates how one might go about using a CloudFormation 
# template to provision EC2 instances, then run an Ansible playbook on the
# newly-provisioned EC2 instance.
# ----------------------------------------------------------------------------

- hosts: localhost
  connection: local
  gather_facts: False

  tasks:

    - name: Create the CloudFormation stack
      cloudformation:
        # aws_access_key: "{{aws_key}}"
        # aws_secret_key: "{{aws_secret}}"
        stack_name: "ansible-cloudformation"
        state: "present"
        region: "us-east-1"
        disable_rollback: true
        template: "cloudformation-examples/example-linux-ec2.yml"
        template_parameters:
          pInstanceProfile: jenkinsRole
          pApplicationName: bastion
          pSshKeyName: nathang-default
          pInstanceSize: t2.micro
          pEC2SecurityGroupIds: sg-03a07a88a4b90adac
          pLinuxType: Amazon
          pSubnetId: subnet-c267e7a5
          pEC2InstanceName: bastion-host
        tags:
          Stack: "ansible-cloudformation"
      register: cfn


    - name: Add public IPs to host group
      add_host: hostname={{ cfn.stack_outputs['InstanceHostName'] }} groups=ec2hosts

    - name: Debug
      debug: var=ansible_facts

- hosts: ec2hosts
  name: Configure
  user: ec2-user
  gather_facts: true
  become_method: sudo
  # vars:
  #   ansible_ssh_private_key_file: "{{aws_ssh_key}}"

  tasks:
    - name: Install web server
      become: yes
      yum:
        name:
        - httpd
        - java-1.8.0-openjdk
        state: present

    - name: Create wildfly group
      group:
        name: wildfly
        state: present
      become: yes

    - name: Create wildfly user
      user:
        name: wildfly
        comment: Wildfly Service Account
        group: wildfly
        state: present
        shell: /bin/nologin
        home: /opt/wildfly
      become: yes

    - name: Download Wildfly server
      unarchive:
        src: https://download.jboss.org/wildfly/16.0.0.Final/wildfly-16.0.0.Final.tar.gz
        dest: /opt/wildfly
        remote_src: yes
        owner: wildfly
        group: wildfly
        extra_opts:
          - "--strip"
          - "1"
      become: yes

    - name: Create log directory
      file:
        path: /opt/wildfly/standalone/logs
        state: directory
        mode: 0755
        owner: wildfly
        group: wildfly
      become: yes

    - name: Start Wildfly server
      shell: "nohup /opt/wildfly/bin/standalone.sh -b=0.0.0.0 -bmanagement=0.0.0.0 > /opt/wildfly/standalone/logs/wildfly-cmd-out.log 2>&1 &"
      poll: 0
      become: yes
